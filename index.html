<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="icon" type="image/png" href="gemini.png"><link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registered!'))
        .catch(err => console.error('Service Worker failed:', err));
    });
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        /* === ã‚¹ãƒãƒ›æœ€é©åŒ–ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼éè¡¨ç¤ºï¼‹ãƒ‘ãƒãƒ«æ•´åˆ—ï¼‰ === */
@media (max-width: 768px) {

    /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ã‚¹ãƒãƒ›ã§éè¡¨ç¤º */
    .suggestion-text {
        display: none !important;
    }

    /* ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ã‚’ã‚ˆã‚Šã‚¹ãƒƒã‚­ãƒªé…ç½® */
    .chat-input-area {
        flex-direction: column;
        padding: 0.75rem;
        gap: 0.4rem;
        background-color: #fff;
        border-top: 1px solid #e5e7eb;
    }

    .input-controls {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        width: 100%;
    }

    .input-container {
        flex-grow: 1;
        position: relative;
        display: flex;
        align-items: center;
    }

    .chat-input {
        width: 100%;
        padding: 0.6rem 1rem;
        font-size: 1rem;
        border-radius: 0.75rem;
    }

    .send-button {
        flex-shrink: 0;
        padding: 0.6rem 0.9rem;
        font-size: 0.9rem;
        border-radius: 0.75rem;
        line-height: 1;
    }

    /* === ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã‚’æ¨ªä¸€åˆ—ã«æ•´åˆ— === */
    .control-panel {
        display: flex;
        flex-wrap: nowrap;
        justify-content: center;
        gap: 0.5rem;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        padding: 0.4rem 0.6rem;
        border-radius: 1rem;
        scrollbar-width: none; /* Firefox */
    }

    .control-panel::-webkit-scrollbar {
        display: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º */
    }

    .control-panel-button {
        flex-shrink: 0;
        padding: 0.4rem 0.75rem;
        font-size: 0.9rem;
        border-radius: 9999px;
        white-space: nowrap;
    }

    .control-panel-container {
        gap: 0.3rem;
    }

    /* iPhoneå®‰å…¨é ˜åŸŸå¯¾å¿œ */
    @supports (padding: max(0px)) {
        .chat-input-area {
            padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
        }
    }
}
        /* === ã‚¹ãƒãƒ›ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º + ãƒ‘ãƒãƒ«é€æ˜åŒ– === */

/* ã™ã¹ã¦ã®ç’°å¢ƒã§ãƒ‘ãƒãƒ«ã®èƒŒæ™¯ã‚’é€æ˜ã«ã™ã‚‹ */
.control-panel {
    background-color: rgba(255, 255, 255, 0.6) !important; /* åŠé€æ˜ã§å¥¥ãŒè¦‹ãˆã‚‹ */
    backdrop-filter: blur(8px); /* èƒŒæ™¯ã¼ã‹ã—ï¼ˆè¿‘ä»£çš„ã§è‡ªç„¶ï¼‰ */
    -webkit-backdrop-filter: blur(8px); /* iOS Safariå¯¾å¿œ */
    border: 1px solid rgba(229, 231, 235, 0.4);
    box-shadow: none;
}

/* ãƒœã‚¿ãƒ³éƒ¨åˆ†ã ã‘è»½ãæµ®ã‹ã›ã‚‹åŠ¹æœ */
.control-panel-button {
    background-color: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(209, 213, 219, 0.3);
    backdrop-filter: blur(6px);
    border-radius: 9999px;
    transition: background-color 0.2s ease, transform 0.2s ease;
}
.control-panel-button:hover {
    background-color: rgba(255, 255, 255, 0.9);
    transform: translateY(-1px);
}

/* === ã‚¹ãƒãƒ›å°‚ç”¨: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å®Œå…¨éè¡¨ç¤º === */
@media (max-width: 768px) {
    ::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
    }

    html, body {
        -ms-overflow-style: none;  /* IE/Edgeå¯¾å¿œ */
        scrollbar-width: none;     /* Firefoxå¯¾å¿œ */
        overflow: -moz-scrollbars-none;
    }

    .chat-messages, 
    .home-grid, 
    .control-panel {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .chat-messages::-webkit-scrollbar,
    .home-grid::-webkit-scrollbar,
    .control-panel::-webkit-scrollbar {
        display: none !important;
    }
}

</style><style>
        :root {
            /* === ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ === */
            --primary-color: #4f46e5;       /* ãƒ¡ã‚¤ãƒ³ã®å¼·èª¿è‰² (é’) */
            --primary-hover-color: #4338ca; /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ã®ãƒ›ãƒãƒ¼ */
            --primary-light-color: #e0e7ff; /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èƒŒæ™¯ */
            --primary-text-color: #312e81;  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆ */
            --secondary-color: #06b6d4;     /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãªã©ã®è‰² (æ°´è‰²) */
            --neon-color: rgba(0, 255, 255, 0.5); /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒã‚ªãƒ³è‰² */
            /* ================================== */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* èƒŒæ™¯è‰² */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        ::-webkit-scrollbar {
            width: 12px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®å¹… */
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--neon-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
            border-radius: 10px;
            border: 3px solid transparent;
            background-clip: padding-box;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®èƒŒæ™¯ã¯ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã«åˆã‚ã›ã¦å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯èª¿æ•´ */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3Cdefs%3E%3Cfilter id='blur'%3E%3CfeGaussianBlur stdDeviation='1.5' /%3E%3C/filter%3E%3C/defs%3E%3Cstyle%3E.kanji%7Bfont-family:sans-serif;font-size:30px;font-weight:bold;fill:cyan;filter:url(%23blur);%7D%3C/style%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' class='kanji'%3Eé’%3C/text%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
        .splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .chat-container {
            background-color: #ffffff;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .chat-container.show {
            opacity: 1;
            transform: translateY(0);
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .message-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .message.user {
            background-color: var(--primary-light-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
            align-self: flex-end;
            color: var(--primary-text-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
        }
        .message.ai {
            background-color: #f3f4f6;
            align-self: flex-start;
            color: #1f2937;
        }
        .chat-input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            background-color: #ffffff;
            position: relative;
            flex-direction: column;
            gap: 0.5rem;
        }
        .input-controls {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
        }
        .input-container {
            flex-grow: 1;
            position: relative;
        }
        .chat-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            outline: none;
            font-size: 1rem;
            background-color: transparent;
            z-index: 2;
            position: relative;
            transition: all 0.3s ease;
            -webkit-appearance: none; /* iOSã§èƒŒæ™¯ãŒé»’ããªã‚‹ã®ã‚’é˜²ã */
        }
        .chat-input:focus {
            border-color: var(--primary-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .thinking-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 500;
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
            z-index: 5; /* ãƒ†ã‚­ã‚¹ãƒˆãŒãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´ */
            white-space: nowrap;
        }

        .suggestion-text {
            position: absolute;
            top: 0;
            left: 0;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: #a0a0a0;
            user-select: none;
            z-index: 1;
            pointer-events: none;
            border: 1px solid transparent;
            border-radius: 0.75rem;
            white-space: pre; /* äºˆæ¸¬å…¥åŠ›ã®ãŸã‚ã«preã‚’æŒ‡å®š */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: pre-wrap; /* æ”¹è¡Œã‚’ä¿æŒ */
            word-break: break-all;
        }
        .send-button {
            background-color: var(--primary-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
            color: #ffffff;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .send-button:hover {
            background-color: var(--primary-hover-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
        }
        .send-button:active {
            transform: scale(0.98);
        }
        .send-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .ripple-effect {
            background-color: rgba(255, 255, 255, 0.7);
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            opacity: 1;
            animation: ripple-animation 0.6s ease-out forwards;
            pointer-events: none;
        }
        @keyframes ripple-animation {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }
        /* ã‚¹ãƒ”ãƒŠãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-container .progress-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background-color: var(--secondary-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
            border-radius: 0.75rem;
            transition: width 0.3s ease-in-out;
            z-index: 4;
        }
        /* ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .percentage-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 500;
            color: #ffffff;
            /* é»’ã„ç¸å–ã‚Šã‚’ä½œæˆ */
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            z-index: 5;
            white-space: nowrap;
        }
        .image-upload-button {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 0.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }
        .image-upload-button:hover {
            background-color: #d1d5db;
        }
        .image-preview-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            border-radius: 0.75rem;
            background-color: var(--primary-light-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
        }
        .image-preview-container img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .remove-image-button {
            color: var(--primary-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .remove-image-button:hover {
            color: var(--primary-hover-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
        }
        
        .translate-button {
            position: absolute;
            bottom: -20px;
            right: 0;
            background-color: var(--primary-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease;
        }
        .translate-button:hover {
            background-color: var(--primary-hover-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
        }
        .material-icons {
            font-size: 24px;
            line-height: 1;
        }

        /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .disclaimer-container {
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.5rem 1rem;
            height: 2rem; /* å›ºå®šã®é«˜ã• */
            position: relative;
            overflow: hidden;
            user-select: none;
            line-height: 2rem; /* ãƒ†ã‚­ã‚¹ãƒˆã‚’å‚ç›´æ–¹å‘ã«ä¸­å¤®æƒãˆ */
        }

        .disclaimer-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: transform 1s ease-in-out;
            transform: translateY(0);
        }

        .disclaimer-text {
            width: 100%;
            height: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æ–°æ©Ÿèƒ½ç”¨ã®ãƒœã‚¿ãƒ³ */
        .chat-header-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .header-button {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        .header-button:hover {
            background-color: #d1d5db;
        }
        /* AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ãƒœã‚¿ãƒ³ */
        .ai-message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .ai-message-button {
            background-color: transparent;
            color: #4b5563;
            border: 1px solid #d1d5db;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .ai-message-button:hover {
            background-color: #e5e7eb;
            color: #333;
        }
        
        .confirmation-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .confirmation-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .delete-button {
            color: #ef4444;
            transition: transform 0.1s ease-in-out;
        }
        .delete-button:hover {
            color: #b91c1c;
            transform: scale(1.1);
        }

        /* ã‚¹ãƒ”ãƒŠãƒ¼ã¨èƒŒæ™¯ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .loading-spinner-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner-container.show {
            display: flex;
        }
        .spinner-background {
            position: absolute;
            width: 150px;
            height: 150px;
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            z-index: 999;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .loading-spinner {
            z-index: 1000;
        }
        .loading-spinner svg {
            width: 120px;
            height: 120px;
        }
        .loading-spinner circle {
            fill: none;
            stroke: blue;
            stroke-width: 20;
            stroke-linecap: round;
            animation: wax-and-wane 2s cubic-bezier(.5, 0, .5, 1) infinite, rotate 1.5s linear infinite;
        }
        @keyframes wax-and-wane {
            0% {
                stroke-dasharray: 236 78;
                stroke-dashoffset: -37;
            }
            50% {
                stroke-dasharray: 20 294;
                stroke-dashoffset: -304;
            }
            100% {
                stroke-dasharray: 236 78;
                stroke-dashoffset: -351;
            }
        }
        @keyframes rotate {
            0% {
                transform: rotate(0);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* æ¨ªç”»é¢ç”¨ã®ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« */
        .home-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .conversation-card {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .conversation-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        /* æ–°ã—ã„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .control-panel-container {
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .control-panel-toggle {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        .control-panel-toggle:hover {
            background-color: #d1d5db;
            transform: translateY(-2px);
        }
        .control-panel {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
            padding: 0.25rem 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 9999px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            max-height: 100px; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .control-panel.hidden {
            max-height: 0;
            opacity: 0;
            pointer-events: none;
        }
        .control-panel-button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 500;
            color: #6b7280;
        }
        .control-panel-button:hover {
            color: var(--primary-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
            transform: translateY(-2px);
        }
        .control-panel-button.selected {
            color: var(--primary-color); /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã‚’ä½¿ç”¨ */
        }

        /* ç”»é¢ä¸‹éƒ¨ã«è¡¨ç¤ºã™ã‚‹é€šçŸ¥ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        #notification-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 90%;
            max-width: 400px;
        }

        .notification {
            background-color: #333;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .notification.hide {
            opacity: 0;
            transform: translateY(20px);
        }
        
        /* ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³ */
        .theme-option-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease, border 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .theme-option-button:hover {
            transform: scale(1.1);
        }
        .theme-option-button.selected {
            border: 3px solid black;
            transform: scale(1.1);
        }
        /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.5rem 0;
            cursor: pointer;
        }
        .toggle-button {
            background-color: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .toggle-button:hover {
            background-color: var(--primary-hover-color);
        }

        /* â˜…è¿½åŠ : åå‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .name-modal {
            display: none;
            position: fixed;
            z-index: 2000; /* ä»–ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šé«˜ã„ z-index */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .name-modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            text-align: center;
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .name-input {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            font-size: 1.1rem;
        }
        /* â˜…è¿½åŠ : ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        #name-validation-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: -10px;
            margin-bottom: 10px;
            height: 20px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="splash-screen" class="splash-screen">
        <img src="gemini.png" width="10%" height="10%">
    </div>

    <div id="nameInputModal" class="name-modal">
        <div class="name-modal-content">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">ã‚ˆã†ã“ãï¼ã‚ãªãŸã®åå‰ã‚’æ•™ãˆã¦ãã ã•ã„ğŸ˜Š</h3>
            <p class="text-gray-600 mb-4">ä¸€åº¦å…¥åŠ›ã™ã‚‹ã¨æ¬¡å›ã‹ã‚‰ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚ï¼ˆæœ¬åã‚’ä½¿ç”¨ã—ãªã„å ´åˆã“ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ãˆãªããªã‚‹ãŠãã‚ŒãŒã‚ã‚Šã¾ã™ï¼‰</p>
            <input type="text" id="userNameInput" class="name-input" placeholder="ä¾‹: å±±ç”°å¤ªéƒï¼ˆæœ¬åï¼‰" maxlength="20">
            <div id="name-validation-message"></div>
            <button id="saveNameButton" class="send-button w-full" disabled>
                ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã™ã‚‹
            </button>
        </div>
    </div>
    <div id="home-screen" class="chat-container p-8 show">
        <div class="flex justify-between items-center w-full max-w-5xl mx-auto mb-8">
            <h1 class="text-4xl font-bold text-gray-800">ä¼šè©±å±¥æ­´</h1>
            <button id="settings-button" class="header-button" title="è¨­å®š">
                <i class="material-icons text-xl">settings</i>
            </button>
        </div>
        <div id="home-conversation-list" class="w-full max-w-5xl mx-auto overflow-y-auto home-grid">
            </div>
        <div class="mt-8 flex flex-col items-center w-full max-w-sm mx-auto">
            <p>æ¢ã—ã¦ã„ã‚‹ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ</p><a id="show-more-button"ã€€style="background-color: skyblue;">ã‚‚ã£ã¨è¦‹ã‚‹</a>
            <button id="new-chat-button" class="send-button w-full rounded-lg">æ–°ã—ã„ä¼šè©±ã‚’å§‹ã‚ã‚‹</button>
        </div>
    </div>
<style>
    a {
        
        color: blue;
        cursor:pointer;
}
        </style>
    <div id="all-conversations-screen" class="chat-container p-8 hidden">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <button id="back-to-home-button" class="text-gray-600 hover:text-gray-800">
                <i class="material-icons">arrow_back_ios</i>
            </button>
            <h2 class="text-xl font-bold text-gray-800 flex-grow text-center">ã™ã¹ã¦ã®ä¼šè©±</h2>
            <div class="w-6"></div> </div>
        <div id="all-conversation-list" class="w-full max-w-5xl mx-auto overflow-y-auto mt-4 home-grid">
            </div>
    </div>
    
    <div id="settings-screen" class="chat-container hidden">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <button id="back-to-home-from-settings-button" class="text-gray-600 hover:text-gray-800">
                <i class="material-icons">arrow_back_ios</i>
            </button>
            <h2 class="text-xl font-bold text-gray-800 flex-grow text-center">è¨­å®š</h2>
            <div class="w-6"></div>
        </div>
        <div class="w-full max-w-2xl mx-auto p-4 overflow-y-auto">
            <div class="bg-white rounded-lg shadow-md divide-y divide-gray-200">
                
                <button id="open-theme-settings-button" class="w-full text-left p-4 flex justify-between items-center hover:bg-gray-50 transition duration-150">
                    <span class="text-lg font-medium text-gray-700 flex items-center gap-2">
                        <i class="material-icons text-xl text-gray-500">palette</i> ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼
                    </span>
                    <span class="text-gray-400">
                        <i class="material-icons">chevron_right</i>
                    </span>
                </button>
                
                <div class="p-4 flex flex-col gap-2">
                    <h4 class="text-sm font-semibold text-gray-500">ãƒãƒ£ãƒƒãƒˆæ“ä½œ</h4>
                    <div id="send-key-toggle-container" class="toggle-container hover:bg-gray-50 rounded-lg p-2 -m-2 transition duration-150">
                        <span class="text-lg font-medium text-gray-700 flex items-center gap-2">
                            <i class="material-icons text-xl text-gray-500">keyboard</i> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚­ãƒ¼
                        </span>
                        <button id="send-key-toggle" class="toggle-button">
                            <span>Enterã‚­ãƒ¼</span> </button>
                    </div>
                </div>

                <div class="p-4 flex flex-col gap-2">
                    <h4 class="text-sm font-semibold text-gray-500">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                    <button id="delete-all-history-button" class="w-full text-left p-4 flex justify-between items-center hover:bg-red-50 transition duration-150 rounded-lg -m-4">
                        <span class="text-lg font-medium text-red-600 flex items-center gap-2">
                            <i class="material-icons text-xl text-red-500">delete_forever</i> ã™ã¹ã¦ã®ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤
                        </span>
                        <span class="text-red-400">
                            <i class="material-icons">chevron_right</i>
                        </span>
                    </button>
                </div>
                 <div class="p-4 flex flex-col gap-2">
                    <h4 class="text-sm font-semibold text-gray-500">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                    <button id="delete-all-history-button" class="w-full text-left p-4 flex justify-between items-center hover:bg-red-50 transition duration-150 rounded-lg -m-4">
                        <span class="text-lg font-medium text-red-600 flex items-center gap-2">
                            <a class="material-icons text-xl text-red-500" src="file:///media/fuse/drivefs-aa835bb4d6b45ac2057ae2d2495a3e67/root/qwertyuiop/ai.html?action=reset_name">delete_forever</a> åå‰ã‚’å†è¨­å®š                 </span>
                        <a src="file:///media/fuse/drivefs-aa835bb4d6b45ac2057ae2d2495a3e67/root/qwertyuiop/ai.html?action=reset_name">åå‰ã‚’ãƒªã‚»ãƒƒãƒˆ</a>
                        <span class="text-red-400">
                            <i class="material-icons">chevron_right</i>
                        </span>
                    </button>
                </div>
                
                
                <div class="p-4">
                    <h4 class="text-sm font-semibold text-gray-500 mb-2">ã‚¢ãƒ—ãƒªæƒ…å ±</h4>
                    <div class="text-gray-700">ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v2.5.0</div>
                </div>

            </div>
        </div>
    </div>
    <div id="chat-view" class="chat-container hidden">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <button id="back-to-home-from-chat-button" class="text-gray-600 hover:text-gray-800">
                <i class="material-icons">arrow_back_ios</i>
            </button>
            <h2 id="chat-title" class="text-xl font-bold text-gray-800 flex-grow text-center">æ–°ã—ã„ä¼šè©±</h2>
            <div class="chat-header-buttons">
                <button id="summarize-button" class="header-button" title="ä¼šè©±ã‚’è¦ç´„ã™ã‚‹">
                    <i class="material-icons text-xl">summarize</i>
                </button>
                <button id="new-chat-from-chat-button" class="header-button" title="æ–°ã—ã„ä¼šè©±ã‚’å§‹ã‚ã‚‹">
                    <i class="material-icons text-xl">add</i>
                </button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages">
            </div>
        <div class="disclaimer-container">
            <div id="disclaimer-wrapper" class="disclaimer-wrapper">
                <div class="disclaimer-text">geminiã¯é–“é•ã£ãŸæƒ…å ±ã‚’æä¾›ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€é‡è¦ãªæƒ…å ±ã¯å¿…ãšå†ç¢ºèªã—ã¦ãã ã•ã„</div>
                <div class="disclaimer-text">Gemini can make mistakes, so double-check it</div>
                <div class="disclaimer-text">GeminiëŠ” ë¶€ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì¤‘ìš”í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.</div>
            </div>
        </div>

        <div class="chat-input-area">
            <div class="control-panel-container">
                <button id="toggle-control-panel-button" class="control-panel-toggle">
                    <i class="material-icons">expand_less</i>
                </button>
                <div id="control-panel" class="control-panel">
                    <button id="length-toggle-button" class="control-panel-button">
                        <i class="material-icons">list_alt</i>
                        <span id="length-label">çŸ­ã„</span>
                    </button>
                    <button id="tone-toggle-button" class="control-panel-button">
                        <i class="material-icons">person_add_alt_1</i>
                        <span id="tone-label">æ•¬èª</span>
                    </button>
                    <button id="language-toggle-button" class="control-panel-button">
                        <i class="material-icons">translate</i>
                        <span id="language-label">å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</span>
                    </button>
                </div>
            </div>
            
            <div id="image-preview-container" class="hidden image-preview-container">
                <div class="flex items-center gap-2">
                    <img id="image-preview" src="#" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ">
                    <span id="image-filename" class="text-sm text-gray-700 font-medium"></span>
                </div>
                <button id="remove-image-button" class="remove-image-button">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="input-controls">
                <label for="image-input" class="image-upload-button">
                    <i class="material-icons">photo_camera</i>
                </label>
                <input type="file" id="image-input" class="hidden" accept="image/png, image/jpeg, image/heic, image/webp">

                <div class="input-container">
                    <div id="progress-bar-in-input" class="progress-bar hidden"></div>
                    <span id="thinking-text" class="percentage-text hidden">
                        <span id="percentage-display"></span>
                        <span id="thinking-display"></span>
                    </span>
                    <span id="suggestion-text" class="suggestion-text"></span>
                    <input type="text" id="chat-input" class="chat-input">
                </div>
                <button id="send-button" class="send-button">é€ä¿¡</button>
            </div>
        </div>
    </div>
    
    <div id="loading-spinner-container" class="loading-spinner-container">
        <div class="spinner-background"></div>
        <div class="loading-spinner">
            <svg width="120" height="120" viewBox="-60 -60 120 120">
                <circle r="50" />
            </svg>
        </div>
    </div>
    
    <div id="notification-container"></div>

    <div id="deleteConfirmationModal" class="confirmation-modal">
        <div class="confirmation-content">
            <p id="delete-confirmation-text">ã“ã®ä¼šè©±ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="confirmation-buttons">
                <button id="confirmDeleteButton" class="send-button bg-red-500 hover:bg-red-700">å‰Šé™¤</button>
                <button id="cancelDeleteButton" class="send-button bg-gray-500 hover:bg-gray-700">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <div id="themeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-theme-modal">&times;</span>
            <h3 class="text-xl font-bold mb-4">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸æŠ</h3>
            <div id="theme-options" class="flex justify-center gap-4">
                </div>
        </div>
    </div>

    <script>
        // APIã‚­ãƒ¼ã‚’ã“ã“ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
        const apiKey = "AIzaSyAecYBAI1E5AH2vs7L52esf9jQKVb-tnvE";

        // ===================================
        // â˜…â˜…â˜… Firebaseã®è¨­å®š (ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®š) â˜…â˜…â˜…
        // ===================================
        const firebaseConfig = {
 apiKey: "AIzaSyC69jHGvP9IzMp9UzygIxxavttbsg7iGGo",
            authDomain: "mail-project-e762c.firebaseapp.com",
            projectId: "mail-project-e762c",
            storageBucket: "mail-project-e762c.firebasestorage.app",
            messagingSenderId: "791285148666",
            appId: "1:791285148666:web:725a3aa0cf6b9c66771243"
        };

        // Firebaseã®åˆæœŸåŒ–ã¨Firestoreã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
        let db;
        try {
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                console.log("Firebase initialized successfully.");
            }
        } catch (e) {
            console.error("Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        }
        
        const SPLASH_DURATION = 500;
        const PROGRESS_INTERVAL = 50;
        const DISCLAIMER_INTERVAL = 5000; // 5ç§’ã”ã¨ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚ˆã†ã«å¤‰æ›´
        
        // äºˆæ¸¬å€™è£œã¨ãªã‚‹å˜èªãƒªã‚¹ãƒˆ
        const SUGGESTIONS = [
            "æ—¥æœ¬ã®é¦–éƒ½ã¯ã©ã“ã§ã™ã‹ï¼Ÿ",
            "ä»Šæ—¥ã®å¤©æ°—ã¯ï¼Ÿ",
            "æ–°ã—ã„è¶£å‘³ã‚’è¦‹ã¤ã‘ã‚‹ã«ã¯ï¼Ÿ",
            "AIã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚",
            "é¢ç™½ã„ã‚¸ãƒ§ãƒ¼ã‚¯ã‚’è¨€ã£ã¦ãã ã•ã„ã€‚",
            "ç°¡å˜ãªæ–™ç†ã®ãƒ¬ã‚·ãƒ”ã‚’æ•™ãˆã¦ã€‚",
            "AIã®å€«ç†çš„ãªå•é¡Œã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚",
            "å®‡å®™é–‹ç™ºã®æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ã¯ä½•ã§ã™ã‹ï¼Ÿ",
            "é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚",
            "Webé–‹ç™ºã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
            "å¥åº·çš„ãªé£Ÿäº‹ã®ãƒ’ãƒ³ãƒˆã‚’æ•™ãˆã¦ãã ã•ã„ã€‚"
        ];

        // è¨­å®šã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨åˆæœŸå€¤
        const SETTINGS = {
            length: {
                options: ['short', 'normal', 'long'],
                labels: ['çŸ­ã„', 'æ™®é€š', 'é•·ã„'],
                current: 'normal'
            },
            tone: {
                options: ['polite', 'casual'],
                labels: ['æ•¬èª', 'ã‚¿ãƒ¡èª'],
                current: 'polite'
            },
            language: {
                options: ['ja', 'en', 'ko'],
                labels: ['å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰', 'æ—¥æœ¬èª', 'í•œêµ­ì–´'],
                current: 'ja'
            },
            sendKey: { // â˜…è¿½åŠ ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚­ãƒ¼è¨­å®š
                options: ['Enter', 'Shift+Enter'],
                labels: ['Enterã‚­ãƒ¼', 'Shift+Enter'],
                current: 'Enter'
            }
        };

        // === ãƒ†ãƒ¼ãƒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ ===
// ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸ã¶å‰ã«ã€ã€Œã“ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚ãªãŸå¥½ã¿ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã€ã¨ã„ã†æ¡ˆå†…ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹

// ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’ä½œæˆ
const modalOverlay = document.createElement('div');
modalOverlay.id = 'theme-modal-overlay';
modalOverlay.style.position = 'fixed';
modalOverlay.style.top = '0';
modalOverlay.style.left = '0';
modalOverlay.style.width = '100%';
modalOverlay.style.height = '100%';
modalOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
modalOverlay.style.display = 'none';
modalOverlay.style.alignItems = 'center';
modalOverlay.style.justifyContent = 'center';
modalOverlay.style.zIndex = '2000';

const modalBox = document.createElement('div');
modalBox.style.background = '#fff';
modalBox.style.borderRadius = '1rem';
modalBox.style.padding = '2rem';
modalBox.style.textAlign = 'center';
modalBox.style.boxShadow = '0 8px 16px rgba(0,0,0,0.2)';
modalBox.style.width = '90%';
modalBox.style.maxWidth = '420px';

const modalImage = document.createElement('img');
modalImage.src = 'm.png'; // ğŸ”¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ç”»åƒã‚’è¡¨ç¤º
modalImage.alt = 'ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ¡ˆå†…ç”»åƒ';
modalImage.style.width = '100%';
modalImage.style.borderRadius = '0.75rem';
modalImage.style.marginBottom = '1rem';

const modalTitle = document.createElement('h2');
modalTitle.textContent = 'ã‚ãªãŸå¥½ã¿ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã—ã‚‡ã†';
modalTitle.style.fontSize = '1.25rem';
modalTitle.style.marginBottom = '0.5rem';

const modalText = document.createElement('p');
modalText.textContent = 'ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸ã¶å‰ã«ã€å°‘ã—ã ã‘è¨­å®šã‚’èª¿æ•´ã—ã¦ã€ã‚ãªãŸã«ã´ã£ãŸã‚Šã®ä½“é¨“ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚';
modalText.style.fontSize = '1rem';
modalText.style.marginBottom = '1.5rem';
modalText.style.color = '#4b5563';

const continueButton = document.createElement('button');
continueButton.textContent = 'ç¶šè¡Œ';
continueButton.style.background = '#3b82f6';
continueButton.style.color = '#fff';
continueButton.style.border = 'none';
continueButton.style.padding = '0.75rem 1.5rem';
continueButton.style.borderRadius = '0.5rem';
continueButton.style.fontSize = '1rem';
continueButton.style.cursor = 'pointer';
continueButton.style.transition = 'background-color 0.2s ease';
continueButton.addEventListener('mouseenter', () => (continueButton.style.backgroundColor = '#2563eb'));
continueButton.addEventListener('mouseleave', () => (continueButton.style.backgroundColor = '#3b82f6'));

continueButton.addEventListener('click', () => {
  modalOverlay.style.display = 'none';
  openThemeSelector(); // ğŸ”¹ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼é¸æŠUIã‚’é–‹ãé–¢æ•°ã‚’å‘¼ã³å‡ºã™ï¼ˆæ—¢å­˜é–¢æ•°ï¼‰
});

modalBox.appendChild(modalImage);
modalBox.appendChild(modalTitle);
modalBox.appendChild(modalText);
modalBox.appendChild(continueButton);
modalOverlay.appendChild(modalBox);
document.body.appendChild(modalOverlay);

// ğŸ”¹ãƒ†ãƒ¼ãƒé¸æŠã®å‰ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã‚ˆã†ã«å¤‰æ›´
function showThemeCustomizationModal() {
  modalOverlay.style.display = 'flex';
}

// æ—¢å­˜ã®ãƒ†ãƒ¼ãƒé¸æŠãƒœã‚¿ãƒ³ã‚’ãƒ•ãƒƒã‚¯
const themeButton = document.querySelector('#theme-button'); // ãƒ†ãƒ¼ãƒå¤‰æ›´ãƒœã‚¿ãƒ³ã®IDã«åˆã‚ã›ã¦å¤‰æ›´
if (themeButton) {
  themeButton.addEventListener('click', e => {
    e.preventDefault();
    showThemeCustomizationModal();
  });
}

        // === ãƒ†ãƒ¼ãƒè¨­å®š ===
        const THEMES = {
            blue: {
                '--primary-color': '#4f46e5',
                '--primary-hover-color': '#4338ca',
                '--primary-light-color': '#e0e7ff',
                '--primary-text-color': '#312e81',
                '--secondary-color': '#06b6d4',
                '--neon-color': 'rgba(0, 255, 255, 0.5)'
            },
            red: {
                '--primary-color': '#9a25d9',
                '--primary-hover-color': '#801bb3',
                '--primary-light-color': '#eed5f5',
                '--primary-text-color': '#791991',
                '--secondary-color': '#e76ef5',
                '--neon-color': 'rgba(255, 0, 0, 0.5)'
            },
            green: {
                '--primary-color': '#10b981',
                '--primary-hover-color': '#059669',
                '--primary-light-color': '#d1fae5',
                '--primary-text-color': '#065f46',
                '--secondary-color': '#34d399',
                '--neon-color': 'rgba(0, 255, 0, 0.5)'
            }

            
            
        };
        
        let currentTheme = localStorage.getItem('currentTheme') || 'blue';
        // ==================

        const splashScreen = document.getElementById('splash-screen');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const thinkingTextElement = document.getElementById('thinking-text');
        const percentageDisplay = document.getElementById('percentage-display');
        const thinkingDisplay = document.getElementById('thinking-display');
        const progressBarInInput = document.getElementById('progress-bar-in-input');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const imageFilename = document.getElementById('image-filename');
        const removeImageButton = document.getElementById('remove-image-button');
        const suggestionTextElement = document.getElementById('suggestion-text');

        const homeScreen = document.getElementById('home-screen');
        const chatView = document.getElementById('chat-view');
        const allConversationsScreen = document.getElementById('all-conversations-screen');
        // --- æ–°ã—ã„è¨­å®šç”»é¢é–¢é€£ã®è¦ç´  ---
        const settingsScreen = document.getElementById('settings-screen');
        const settingsButton = document.getElementById('settings-button');
        const backToHomeFromSettingsButton = document.getElementById('back-to-home-from-settings-button');
        const openThemeSettingsButton = document.getElementById('open-theme-settings-button');
        const sendKeyToggle = document.getElementById('send-key-toggle'); 
        const deleteAllHistoryButton = document.getElementById('delete-all-history-button'); 
        // --------------------------------

        const newChatButton = document.getElementById('new-chat-button');
        const showMoreButton = document.getElementById('show-more-button');
        const backToHomeButton = document.getElementById('back-to-home-button');
        const backToHomeFromChatButton = document.getElementById('back-to-home-from-chat-button');
        const newChatFromChatButton = document.getElementById('new-chat-from-chat-button');
        const summarizeButton = document.getElementById('summarize-button');

        const homeConversationList = document.getElementById('home-conversation-list');
        const allConversationList = document.getElementById('all-conversation-list');
        const chatTitleElement = document.getElementById('chat-title');
        
        const disclaimerWrapper = document.getElementById('disclaimer-wrapper');
        const disclaimerTexts = document.querySelectorAll('.disclaimer-text');
        let disclaimerIndex = 0;

        // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®è¦ç´ 
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const deleteConfirmationText = document.getElementById('delete-confirmation-text'); 
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        let conversationToDelete = null;

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼è¦ç´ 
        const loadingSpinnerContainer = document.getElementById('loading-spinner-container');

        // é€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ 
        const notificationContainer = document.getElementById('notification-container');
        
        // ãƒ‘ãƒãƒ«ãƒˆã‚°ãƒ«é–¢é€£ã®è¦ç´ 
        const toggleControlPanelButton = document.getElementById('toggle-control-panel-button');
        const controlPanel = document.getElementById('control-panel');
        const lengthToggleButton = document.getElementById('length-toggle-button');
        const toneToggleButton = document.getElementById('tone-toggle-button');
        const languageToggleButton = document.getElementById('language-toggle-button');
        
        // === ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®è¦ç´  ===
        const themeModal = document.getElementById('themeModal');
        const themeOptionsContainer = document.getElementById('theme-options');
        const closeThemeModalButton = document.getElementById('close-theme-modal');
        // ================================
        
        // â˜…ä¿®æ­£: åå‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®è¦ç´ 
        const nameInputModal = document.getElementById('nameInputModal');
        const userNameInput = document.getElementById('userNameInput');
        const saveNameButton = document.getElementById('saveNameButton');
        const nameValidationMessage = document.getElementById('name-validation-message'); // â˜…è¿½åŠ 

        let chatHistory = [];
        let currentConversationId = null;
        let progressInterval;
        let progress = 0;
        let uploadedImage = null; 
        let currentSuggestion = '';
        
        // â˜…è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let userName = '';
        
        /**
         * ç°¡æ˜“çš„ãªæœ¬åãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: 2æ–‡å­—ä»¥ä¸Šã®æ—¥æœ¬èªï¼ˆæ¼¢å­—ã€ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠï¼‰
         * @param {string} name - å…¥åŠ›ã•ã‚ŒãŸåå‰
         * @returns {boolean} - æœ¬åã¨åˆ¤æ–­ã§ãã‚‹å½¢å¼ã‹
         */
        function validateRealName(name) {
            // 2æ–‡å­—ä»¥ä¸Šã®æ—¥æœ¬èªï¼ˆæ¼¢å­—ã€ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠï¼‰ã«ãƒãƒƒãƒ
            const realNameRegex = /^[ã-ã‚“ã‚¡-ãƒ¶ä¸€-é¾ ]{2,}$/;
            return realNameRegex.test(name);
        }

        /**
         * URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€åå‰ãƒªã‚»ãƒƒãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹
         */
        function handleUrlActions() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'reset_name') {
                if (localStorage.getItem('userName')) {
                    localStorage.removeItem('userName');
                    showNotification('ç®¡ç†è€…ã«ã‚ˆã‚Šåå‰æƒ…å ±ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚æœ¬åã§å†åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
                    // URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€å†ãƒ­ãƒ¼ãƒ‰ã‚’é˜²ã
                    history.replaceState(null, '', window.location.pathname);
                } else {
                     showNotification('åå‰æƒ…å ±ã¯æ—¢ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚', 'info');
                }
            }
        }
        
        // ãƒ­ãƒ¼ãƒ‰å‰ã«URLã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†
        handleUrlActions();


        window.addEventListener('load', () => {
            // æœ€åˆã«åå‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
            checkUserNameAndInitialize();
        });
        
        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å­˜åœ¨ã—ãªã‘ã‚Œã°åå‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
         */
        function checkUserNameAndInitialize() {
            userName = localStorage.getItem('userName');
            
            if (userName) {
                // åå‰ãŒLocal Storageã«ã‚ã‚Œã°ã€ãã®ã¾ã¾ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
                initializeApp();
            } else {
                // åå‰ãŒãªã‘ã‚Œã°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                nameInputModal.style.display = 'flex';
                // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã¯ã™ãã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã•ã›ã‚‹
                splashScreen.classList.add('fade-out');
                
                // åå‰å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š (ä¿®æ­£)
                userNameInput.addEventListener('input', () => {
                    const inputName = userNameInput.value.trim();
                    const isValid = validateRealName(inputName);
                    
                    saveNameButton.disabled = !isValid;
                    nameValidationMessage.textContent = isValid || inputName.length === 0 ? '' : 'âš ï¸ 2æ–‡å­—ä»¥ä¸Šã®æ—¥æœ¬èªï¼ˆæ¼¢å­—ãƒ»ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠï¼‰ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                });
                
                saveNameButton.addEventListener('click', saveUserName);
            }
        }

        /**
         * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–å‡¦ç†
         */
        function initializeApp() {
            applyTheme(currentTheme); 
            // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€å¿µã®ãŸã‚ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            splashScreen.classList.add('fade-out'); 
            
            renderHomeConversations();
            setInterval(updateDisclaimer, DISCLAIMER_INTERVAL);
            updateSuggestionText();
            loadSettings(); 
            updateToggleButtonLabels();
            updateSendKeyToggleText(); 
            
            // åå‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚‚ã—è¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚‰éè¡¨ç¤ºã«ã™ã‚‹
            nameInputModal.style.display = 'none';
        }

        /**
         * å…¥åŠ›ã•ã‚ŒãŸåå‰ã‚’ä¿å­˜ã—ã€ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã™ã‚‹ (ä¿®æ­£)
         */
        function saveUserName() {
            const inputName = userNameInput.value.trim();
            if (inputName && validateRealName(inputName)) {
                localStorage.setItem('userName', inputName);
                userName = inputName;
                showNotification(`${userName}ã•ã‚“ã€ã‚ˆã†ã“ãï¼ğŸ‘‹`, "success");
                initializeApp(); // åå‰ãŒä¿å­˜ã•ã‚ŒãŸã®ã§ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
            } else if (inputName) {
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                 showNotification("æœ¬åå½¢å¼ã®å…¥åŠ›ãŒå¿…è¦ã§ã™ï¼ˆ2æ–‡å­—ä»¥ä¸Šã®æ—¥æœ¬èªï¼‰ã€‚", "error");
            }
        }
        
        // ====================
        //  ãƒ†ãƒ¼ãƒã®é©ç”¨ã¨åˆ‡ã‚Šæ›¿ãˆ
        // ====================
        /**
         * é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒã‚’é©ç”¨ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚
         * @param {string} themeName - ãƒ†ãƒ¼ãƒã®åå‰ (ä¾‹: 'blue', 'red')
         */
        function applyTheme(themeName) {
            const theme = THEMES[themeName];
            if (!theme) return;
            
            const root = document.documentElement;
            for (const [property, value] of Object.entries(theme)) {
                root.style.setProperty(property, value);
            }
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®èƒŒæ™¯ç”»åƒã®è‰²ã‚’å‹•çš„ã«å¤‰æ›´ï¼ˆä¾‹ã¨ã—ã¦ã€Œé’ã€ã®æ¼¢å­—ã‚’ä½¿ç”¨ï¼‰
            let kanjiColor = 'cyan';
            if (themeName === 'red') kanjiColor = 'red';
            if (themeName === 'green') kanjiColor = 'lime';
            
            const kanji = themeName === 'red' ? 'èµ¤' : themeName === 'green' ? 'ç·‘' : 'é’';

            const svgData = encodeURIComponent(`
                <svg xmlns='http://www.w3.org/2000/svg' width='100%' height='100%'>
                    <defs>
                        <filter id='blur'>
                            <feGaussianBlur stdDeviation='1.5' />
                        </filter>
                    </defs>
                    <style>
                        .kanji{
                            font-family:sans-serif;
                            font-size:30px;
                            font-weight:bold;
                            fill:${kanjiColor};
                            filter:url(#blur);
                        }
                    </style>
                    <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' class='kanji'>${kanji}</text>
                </svg>
            `);

            const scrollbarThumbStyle = document.createElement('style');
            scrollbarThumbStyle.textContent = `
                ::-webkit-scrollbar-thumb {
                    background-image: url("data:image/svg+xml,${svgData}");
                }
            `;
            // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å†è¿½åŠ 
            const oldStyle = document.querySelector('style[data-scrollbar-theme]');
            if (oldStyle) oldStyle.remove();
            scrollbarThumbStyle.setAttribute('data-scrollbar-theme', 'true');
            document.head.appendChild(scrollbarThumbStyle);
            
            currentTheme = themeName;
            localStorage.setItem('currentTheme', themeName);
        }

        // ãƒ†ãƒ¼ãƒã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderThemeOptions() {
            themeOptionsContainer.innerHTML = '';
            Object.keys(THEMES).forEach(themeName => {
                const primaryColor = THEMES[themeName]['--primary-color'];
                const button = document.createElement('button');
                button.classList.add('theme-option-button');
                button.style.backgroundColor = primaryColor;
                button.title = themeName.charAt(0).toUpperCase() + themeName.slice(1);
                
                if (currentTheme === themeName) {
                    button.classList.add('selected');
                }
                
                button.onclick = () => {
                    applyTheme(themeName);
                    renderThemeOptions(); // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«ãƒœãƒ¼ãƒ€ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                };
                themeOptionsContainer.appendChild(button);
            });
        }
        
        // ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã€è¨­å®šç”»é¢ã®ãƒœã‚¿ãƒ³ã«å¤‰æ›´
        openThemeSettingsButton.addEventListener('click', () => {
            renderThemeOptions(); 
            themeModal.style.display = 'flex';
        });

        closeThemeModalButton.addEventListener('click', () => {
            themeModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === themeModal) {
                themeModal.style.display = 'none';
            }
        });

        // ====================
        //  è¨­å®šã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿
        // ====================
        function saveSettings() {
            localStorage.setItem('aiSettings', JSON.stringify(SETTINGS));
        }

        function loadSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('aiSettings'));
            if (savedSettings) {
                Object.keys(savedSettings).forEach(key => {
                    if (SETTINGS[key]) { // æ—¢å­˜ã®è¨­å®šã‚­ãƒ¼ã‹ç¢ºèª
                        SETTINGS[key].current = savedSettings[key].current;
                    }
                });
            } else {
                saveSettings();
            }
        }
        
        function updateToggleButtonLabels() {
            document.getElementById('length-label').textContent = SETTINGS.length.labels[SETTINGS.length.options.indexOf(SETTINGS.length.current)];
            document.getElementById('tone-label').textContent = SETTINGS.tone.labels[SETTINGS.tone.options.indexOf(SETTINGS.tone.current)];
            document.getElementById('language-label').textContent = SETTINGS.language.labels[SETTINGS.language.options.indexOf(SETTINGS.language.current)];
        }
        
        // â˜…ä¿®æ­£ï¼šé€ä¿¡ã‚­ãƒ¼ã®ãƒˆã‚°ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
        function updateSendKeyToggleText() {
            const currentSetting = SETTINGS.sendKey.current;
            const label = SETTINGS.sendKey.labels[SETTINGS.sendKey.options.indexOf(currentSetting)];
            sendKeyToggle.querySelector('span').textContent = label;
        }

        function toggleSetting(settingKey) {
            const setting = SETTINGS[settingKey];
            const currentIndex = setting.options.indexOf(setting.current);
            const nextIndex = (currentIndex + 1) % setting.options.length;
            setting.current = setting.options[nextIndex];
            saveSettings();
            if (settingKey === 'sendKey') {
                 updateSendKeyToggleText(); // é€ä¿¡ã‚­ãƒ¼ã®è¡¨ç¤ºã‚’æ›´æ–°
            } else {
                updateToggleButtonLabels();
            }
        }

        lengthToggleButton.addEventListener('click', () => toggleSetting('length'));
        toneToggleButton.addEventListener('click', () => toggleSetting('tone'));
        languageToggleButton.addEventListener('click', () => toggleSetting('language'));
        
        // â˜…ä¿®æ­£ï¼šé€ä¿¡ã‚­ãƒ¼ã®ãƒˆã‚°ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        sendKeyToggle.addEventListener('click', () => {
            toggleSetting('sendKey');
        });
        
        // ãƒ‘ãƒãƒ«ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
        toggleControlPanelButton.addEventListener('click', () => {
            const icon = toggleControlPanelButton.querySelector('.material-icons');
            const isHidden = controlPanel.classList.toggle('hidden');
            icon.textContent = isHidden ? 'expand_more' : 'expand_less';
        });

        /**
         * å…¥åŠ›å†…å®¹ã«åŸºã¥ã„ã¦äºˆæ¸¬å€™è£œã‚’æ¤œç´¢ã—ã€è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
         */
        function updateSuggestionText() {
            const inputValue = chatInput.value.trim();

            if (inputValue.length === 0) {
                // å…¥åŠ›ãŒãªã„å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ãªå€™è£œã‚’ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦è¡¨ç¤º
                const randomSuggestion = SUGGESTIONS[Math.floor(Math.random() * SUGGESTIONS.length)];
                suggestionTextElement.textContent = randomSuggestion;
                suggestionTextElement.style.opacity = '0.5';
                currentSuggestion = randomSuggestion; // Tabã‚­ãƒ¼ç”¨ã«å€™è£œã‚’ä¿å­˜
            } else {
                // å…¥åŠ›ãŒã‚ã‚‹å ´åˆã€ä¸€è‡´ã™ã‚‹æœ€åˆã®å€™è£œã‚’æ¢ã™
                const matched = SUGGESTIONS.find(s => s.toLowerCase().startsWith(inputValue.toLowerCase()));
                if (matched) {
                    suggestionTextElement.textContent = matched;
                    suggestionTextElement.style.opacity = '0.5';
                    currentSuggestion = matched;
                } else {
                    suggestionTextElement.textContent = '';
                    currentSuggestion = '';
                }
            }
        }
        
        chatInput.addEventListener('input', updateSuggestionText);
        chatInput.addEventListener('focus', updateSuggestionText);
        chatInput.addEventListener('blur', () => {
             // å…¥åŠ›æ¬„ãŒç©ºã®å ´åˆã«ã®ã¿å€™è£œã‚’å†è¡¨ç¤º
             if (chatInput.value.trim() === '') {
                updateSuggestionText();
            } else {
                suggestionTextElement.style.opacity = '0';
            }
        });

        // === AIãƒ™ãƒ¼ã‚¹äºˆæ¸¬å…¥åŠ›æ©Ÿèƒ½ï¼ˆå¸¸ã«1ä»¶è¡¨ç¤ºãƒ»ä¸Šæ›¸ãç‰ˆï¼‰ ===
// å…¥åŠ›å†…å®¹ã«å¯¾ã—ã¦AIãŒ1ä»¶ã®ã¿å€™è£œã‚’æç¤ºã—ã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ä¸Šæ›¸ãã™ã‚‹

const suggestionListContainer = document.createElement('div');
suggestionListContainer.id = 'suggestion-list';
suggestionListContainer.style.position = 'absolute';
suggestionListContainer.style.bottom = '60px';
suggestionListContainer.style.left = '1rem';
suggestionListContainer.style.right = '1rem';
suggestionListContainer.style.background = '#fff';
suggestionListContainer.style.border = '1px solid #d1d5db';
suggestionListContainer.style.borderRadius = '0.5rem';
suggestionListContainer.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
suggestionListContainer.style.zIndex = '100';
suggestionListContainer.style.display = 'none';
suggestionListContainer.style.padding = '0.75rem 1rem';

const inputContainer = document.querySelector('.input-container');
inputContainer.appendChild(suggestionListContainer);

let currentSuggestionRequest = 0;

async function generateSingleAISuggestion(query) {
  if (!query || query.length < 2) return '';

  try {
    const requestId = ++currentSuggestionRequest;

    const payload = {
      contents: [{ role: 'user', parts: [{ text: `æ¬¡ã®å…¥åŠ›ã€Œ${query}ã€ã‚’è‡ªç„¶ãªæ—¥æœ¬èªã®æ–‡ã«ç™ºå±•ã•ã›ã‚‹1æ–‡ã ã‘ææ¡ˆã—ã¦ãã ã•ã„ã€‚æ–‡ä»¥å¤–ã¯å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚` }] }]
    };
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (requestId !== currentSuggestionRequest) return '';

    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';
    const suggestion = text.split('\n')[0].replace(/^[0-9\.-\s]+/, '').trim();

    return suggestion;
  } catch (e) {
    console.error('AIå€™è£œç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
    return '';
  }
}

async function updateSingleSuggestion() {
  const inputValue = chatInput.value.trim();
  suggestionListContainer.style.display = 'none';
  suggestionListContainer.textContent = '';

  if (!inputValue) return;

  const suggestion = await generateSingleAISuggestion(inputValue);
  if (!suggestion) return;

  suggestionListContainer.textContent = suggestion;
  suggestionListContainer.style.display = 'block';

  // ğŸ”¹ã‚¯ãƒªãƒƒã‚¯ã§ã€Œä¸Šæ›¸ãã€ã™ã‚‹å‹•ä½œ
  suggestionListContainer.onclick = () => {
    chatInput.value = suggestion;
    chatInput.focus();
    suggestionListContainer.style.display = 'none';
  };
}

chatInput.addEventListener('input', updateSingleSuggestion);

chatInput.addEventListener('keydown', e => {
  if (e.key === 'Tab' && suggestionListContainer.style.display === 'block') {
    e.preventDefault();
    suggestionListContainer.click();
  }
  if (e.key === 'Enter' && chatInput.value.trim()) {
    localStorage.setItem('lastInput', chatInput.value.trim());
  }
});

document.addEventListener('click', e => {
  if (!inputContainer.contains(e.target)) {
    suggestionListContainer.style.display = 'none';
  }
});

        /**
         * Tabã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã‚’å®šç¾©ã—ã¾ã™ã€‚
         *
         * @param {KeyboardEvent} event - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function handleKeydown(event) {
            // Tabã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã€ã‹ã¤äºˆæ¸¬å€™è£œãŒã‚ã‚‹å ´åˆ
            if (event.key === 'Tab' && currentSuggestion) {
                event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¿ãƒ–ç§»å‹•ã‚’é˜²æ­¢
                chatInput.value = currentSuggestion; // å€™è£œã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å…¥åŠ›
                suggestionTextElement.textContent = ''; // äºˆæ¸¬å€™è£œã‚’ã‚¯ãƒªã‚¢
                currentSuggestion = '';
            }
            
            // â˜…ä¿®æ­£ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚­ãƒ¼ã®è¨­å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’åæ˜ 
            if (event.key === 'Enter') {
                const sendKeySetting = SETTINGS.sendKey.current;

                if (sendKeySetting === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); // Enterå˜ç‹¬ã§é€ä¿¡
                    sendButton.click();
                } else if (sendKeySetting === 'Shift+Enter' && event.shiftKey) {
                    event.preventDefault(); // Shift+Enterã§é€ä¿¡
                    sendButton.click();
                }
                // ãã‚Œä»¥å¤– (Enterè¨­å®šã§Shift+Enterã€ã¾ãŸã¯Shift+Enterè¨­å®šã§Enterå˜ç‹¬) ã¯ã€
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œ (æ”¹è¡Œ) ã‚’è¨±å¯ã™ã‚‹
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
        chatInput.addEventListener('keydown', handleKeydown);

        // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°
        function updateDisclaimer() {
            disclaimerIndex = (disclaimerIndex + 1) % disclaimerTexts.length;
            disclaimerWrapper.style.transform = `translateY(-${disclaimerIndex * 2}rem)`;
        }


        // ====================
        //  UIã®åˆ‡ã‚Šæ›¿ãˆ
        // ====================
        function transitionScreen(targetScreen) {
            const currentScreen = document.querySelector('.chat-container.show');
            if (currentScreen) {
                currentScreen.classList.remove('show');
                setTimeout(() => {
                    currentScreen.classList.add('hidden');
                    targetScreen.classList.remove('hidden');
                    setTimeout(() => {
                        targetScreen.classList.add('show');
                    }, 400); // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ™‚é–“ã¨åˆã‚ã›ã‚‹
                }, 400); // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ™‚é–“ã¨åˆã‚ã›ã‚‹
            } else {
                targetScreen.classList.remove('hidden');
                setTimeout(() => {
                    targetScreen.classList.add('show');
                }, 10);
            }
        }

        function showHomeScreen() {
            transitionScreen(homeScreen);
            renderHomeConversations();
        }

        function showChatView() {
            transitionScreen(chatView);
        }

        function showAllConversationsScreen() {
            transitionScreen(allConversationsScreen);
            renderAllConversations();
        }

        function showSettingsScreen() {
            transitionScreen(settingsScreen);
        }

        newChatButton.addEventListener('click', () => {
            startNewChat();
            showChatView();
        });

        showMoreButton.addEventListener('click', () => {
            showAllConversationsScreen();
        });

        backToHomeButton.addEventListener('click', () => {
            showHomeScreen();
        });

        backToHomeFromChatButton.addEventListener('click', () => {
            showHomeScreen();
        });

        newChatFromChatButton.addEventListener('click', () => {
            startNewChat();
            chatTitleElement.textContent = "æ–°ã—ã„ä¼šè©±";
        });
        
        // --- è¨­å®šç”»é¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        settingsButton.addEventListener('click', () => {
            showSettingsScreen();
        });

        backToHomeFromSettingsButton.addEventListener('click', () => {
            showHomeScreen();
        });
        // ---------------------------------
        
        // ====================
        //  AIã«ã‚ˆã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã®ç”Ÿæˆ
        // ====================
        async function generateTitleFromHistory(history) {
            if (history.length === 0) {
                return "æ–°ã—ã„ä¼šè©±";
            }
            const prompt = `ã“ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«åŸºã¥ã„ã¦ã€çŸ­ãã€ä¸€æ–‡ã§ã€10èªä»¥å†…ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚å›ç­”ã¯ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ã«ã—ã¦ãã ã•ã„ã€‚ãƒãƒ£ãƒƒãƒˆå±¥æ­´: ${JSON.stringify(history)}`;
            
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }

                const result = await response.json();
                const title = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return title || "ã‚¿ã‚¤ãƒˆãƒ«ãªã—";

            } catch (error) {
                console.error('ã‚¿ã‚¤ãƒˆãƒ«ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                return "ã‚¿ã‚¤ãƒˆãƒ«ãªã—";
            }
        }
        
        // ====================
        //  AIã«ã‚ˆã‚‹è¦ç´„æ©Ÿèƒ½
        // ====================
        async function summarizeChat() {
            if (chatHistory.length < 2) {
                showNotification("è¦ç´„ã«ã¯å°‘ãªãã¨ã‚‚2ã¤ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¿…è¦ã§ã™ã€‚", "warning");
                return;
            }

            // æœ€å¾Œã®AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¦ã€è¦ç´„ã‚’æŒ¿å…¥ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            const lastMessage = chatHistory[chatHistory.length - 1];
            if (lastMessage.role === 'model' && lastMessage.parts[0].text.startsWith('âœ¨ï¼ˆè¦ç´„ï¼‰')) {
                // æ—¢ã«è¦ç´„ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
                showNotification("ã“ã®ä¼šè©±ã¯æ—¢ã«è¦ç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚", "info");
                return;
            }
            
            const prompt = `ä»¥ä¸‹ã®ãƒãƒ£ãƒƒãƒˆã®ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ç°¡æ½”ãªæ—¥æœ¬èªã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚\n\nãƒãƒ£ãƒƒãƒˆå±¥æ­´:\n${JSON.stringify(chatHistory)}`;
            
            setLoadingState(true, "è¦ç´„ä¸­...");

            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }

                const result = await response.json();
                const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (summaryText) {
                    const summaryMessage = { role: 'model', parts: [{ text: `âœ¨ï¼ˆè¦ç´„ï¼‰ ${summaryText}` }] };
                    addMessage(summaryMessage);
                    chatHistory.push(summaryMessage);
                    saveConversation();
                } else {
                    showNotification("è¦ç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚", "error");
                }

            } catch (error) {
                console.error('è¦ç´„ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                showNotification(`è¦ç´„ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, "error");
            } finally {
                setLoadingState(false);
            }
        }

        // ====================
        //  AIä¼šè©±ã®éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½
        // ====================
        async function playAudioFromText(text) {
            setLoadingState(true, "èª­ã¿ä¸Šã’æº–å‚™ä¸­...");

            try {
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Iapetus" } // æ—¥æœ¬èªã«åˆã†å£°
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`TTS APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        setLoadingState(false);
                    };

                } else {
                    showNotification("éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
                }
                
            } catch (error) {
                console.error("TTSã‚¨ãƒ©ãƒ¼:", error);
                showNotification(`éŸ³å£°èª­ã¿ä¸Šã’ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, "error");
            } finally {
                setLoadingState(false);
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const pcmDataLength = pcm16.length * 2;
            const buffer = new ArrayBuffer(44 + pcmDataLength);
            const view = new DataView(buffer);
            
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset++, str.charCodeAt(i));
                }
            }

            function writeUint32(val) {
                view.setUint32(offset, val, true);
                offset += 4;
            }

            function writeUint16(val) {
                view.setUint16(offset, val, true);
                offset += 2;
            }

            // RIFF chunk
            writeString('RIFF');
            writeUint32(36 + pcmDataLength);
            writeString('WAVE');

            // fmt chunk
            writeString('fmt ');
            writeUint32(16);
            writeUint16(1); // PCM
            writeUint16(1); // Mono
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2); // Byte rate
            writeUint16(2); // Block align
            writeUint16(16); // Bits per sample

            // data chunk
            writeString('data');
            writeUint32(pcmDataLength);
            
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        // ===================================
        // â˜…â˜…â˜… Firebaseãƒ­ã‚°è¨˜éŒ²é–¢æ•° (ä¿®æ­£) â˜…â˜…â˜…
        // ===================================
        async function logConversationToFirebase(userMessage, aiResponse, conversationId) {
            if (!db) return; 
            
            // â˜…ä¿®æ­£: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
            const currentUserName = localStorage.getItem('userName') || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';

            // ä¼šè©±ã®1ã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨AIã®ã‚„ã‚Šå–ã‚Šï¼‰ã‚’ãƒ­ã‚°ã¨ã—ã¦è¨˜éŒ²
            const logData = {
                conversationId: conversationId || 'new_chat',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userName: currentUserName, // â˜…è¿½åŠ 
                userMessage: userMessage,
                aiResponse: aiResponse,
                settings: JSON.parse(localStorage.getItem('aiSettings') || '{}'),
                hasImage: uploadedImage ? true : false
            };

            try {
                // 'chat_logs'ã¨ã„ã†ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                await db.collection("chat_logs").add(logData);
                console.log("ãƒ­ã‚°ã‚’Firebaseã«è¨˜éŒ²ã—ã¾ã—ãŸï¼");
            } catch (e) {
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ãƒ¡ã‚¤ãƒ³ã®ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¯åœæ­¢ã—ãªã„ã‚ˆã†ã«ã—ã¾ã™
                console.error("Firebaseã¸ã®ãƒ­ã‚°è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            }
        }
        
        // ====================
        //  ä¼šè©±ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿ã€å‰Šé™¤
        // ====================
        async function saveConversation() {
            if (chatHistory.length === 0) return;

            const lastUserMessage = chatHistory.findLast(msg => msg.role === 'user');
            const lastUserMessageText = lastUserMessage?.parts.find(p => p.text)?.text || lastUserMessage?.parts.find(p => p.inlineData) ? 'ç”»åƒä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸' : '';
            const savedTime = new Date().toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
            const title = await generateTitleFromHistory(chatHistory.slice(-4)); // ç›´è¿‘ã®4ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ

            let found = false;
            for (let i = 0; i < conversations.length; i++) {
                if (conversations[i].id === currentConversationId) {
                    conversations[i].title = title;
                    conversations[i].savedTime = savedTime;
                    conversations[i].lastUserMessage = lastUserMessageText;
                    const updatedConv = conversations.splice(i, 1)[0];
                    conversations.unshift(updatedConv);
                    found = true;
                    break;
                }
            }

            if (!found) {
                currentConversationId = Date.now().toString();
                conversations.unshift({ id: currentConversationId, title: title, savedTime: savedTime, lastUserMessage: lastUserMessageText });
            }

            localStorage.setItem('conversations', JSON.stringify(conversations));
            localStorage.setItem(`chat_${currentConversationId}`, JSON.stringify(chatHistory));
            renderHomeConversations();
        }

        function loadConversation(id) {
            const history = JSON.parse(localStorage.getItem(`chat_${id}`));
            if (history) {
                chatHistory = history;
                currentConversationId = id;
                chatMessages.innerHTML = '';
                chatHistory.forEach(msg => {
                    addMessage(msg, false);
                });
                const conv = JSON.parse(localStorage.getItem('conversations')).find(c => c.id === id);
                chatTitleElement.textContent = conv ? conv.title : 'æ–°ã—ã„ä¼šè©±';
                showChatView();
            }
        }

        function startNewChat() {
            chatHistory = [];
            currentConversationId = null;
            chatMessages.innerHTML = '';
            chatTitleElement.textContent = 'æ–°ã—ã„ä¼šè©±';
            addMessage({ role: 'model', parts: [{ text: `ã“ã‚“ã«ã¡ã¯ã€${userName || 'ã‚²ã‚¹ãƒˆ'}ã•ã‚“ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ` }] });
            updateSuggestionText(); // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ãŸå¾Œã€å€™è£œã‚’æ›´æ–°
        }
        
        function deleteConversation(id) {
            let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
            conversations = conversations.filter(conv => conv.id !== id);
            localStorage.setItem('conversations', JSON.stringify(conversations));
            localStorage.removeItem(`chat_${id}`);
            
            // ç¾åœ¨è¡¨ç¤ºä¸­ã®ä¼šè©±ã‚’å‰Šé™¤ã—ãŸå ´åˆã€æ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹ã™ã‚‹
            if (currentConversationId === id) {
                startNewChat();
            }
            
            showNotification("ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚", "success");
            renderHomeConversations();
            renderAllConversations();
        }

        // â˜…ä¿®æ­£ï¼šå…¨ä¼šè©±å±¥æ­´ã®å‰Šé™¤æ©Ÿèƒ½
        function deleteAllConversations() {
            let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
            conversations.forEach(conv => {
                localStorage.removeItem(`chat_${conv.id}`);
            });
            localStorage.removeItem('conversations');
            localStorage.removeItem('aiSettings'); // è¨­å®šã‚‚ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚è‰¯ã„ã‹ã‚‚
            
            // ç¾åœ¨ã®ä¼šè©±ã‚‚ãƒªã‚»ãƒƒãƒˆ
            startNewChat(); 
            showNotification("ã™ã¹ã¦ã®ä¼šè©±å±¥æ­´ã¨è¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚", "success");
            
            // å†åº¦è¨­å®šã‚’èª­ã¿è¾¼ã¿
            loadSettings(); 
            updateSendKeyToggleText(); 
            updateToggleButtonLabels();
            
            renderHomeConversations();
        }

        function renderHomeConversations() {
            const conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
            homeConversationList.innerHTML = '';

            const conversationsToDisplay = conversations.slice(0, 5);

            if (conversationsToDisplay.length === 0) {
                homeConversationList.innerHTML = '<p class="text-center text-gray-500 col-span-full">ã¾ã ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                showMoreButton.classList.add('hidden');
                return;
            }

            conversationsToDisplay.forEach(conv => {
                const item = createConversationItem(conv, homeConversationList);
                homeConversationList.appendChild(item);
            });

            if (conversations.length > 5) {
                showMoreButton.classList.remove('hidden');
            } else {
                showMoreButton.classList.add('hidden');
            }
        }

        function renderAllConversations() {
            const conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
            allConversationList.innerHTML = '';
            if (conversations.length === 0) {
                allConversationList.innerHTML = '<p class="text-center text-gray-500 col-span-full">ã¾ã ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            conversations.forEach(conv => {
                const item = createConversationItem(conv, allConversationList);
                allConversationList.appendChild(item);
            });
        }

        function createConversationItem(conv, parentList) {
            const li = document.createElement('div');
            li.className = 'conversation-card cursor-pointer';
            li.dataset.id = conv.id;
            
            li.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <h3 class="font-bold text-gray-800 text-lg truncate pr-4">${conv.title || 'ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆä¸­...'}</h3>
                    <div class="flex items-center gap-2">
                        <p class="text-xs text-gray-500">${conv.savedTime || ''}</p>
                        <button class="delete-button text-red-500 hover:text-red-700">
                            <i class="material-icons">delete</i>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-600 truncate">${conv.lastUserMessage || ''}</p>
            `;
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³ã¨ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’åˆ†é›¢
            li.querySelector('.delete-button').addEventListener('click', (e) => {
                e.stopPropagation(); // è¦ªè¦ç´ ã¸ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢
                conversationToDelete = conv.id;
                deleteConfirmationText.textContent = 'ã“ã®ä¼šè©±ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'; // â˜…ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã®åˆ‡ã‚Šæ›¿ãˆ
                deleteConfirmationModal.style.display = 'flex';
            });
            
            li.addEventListener('click', () => {
                loadConversation(conv.id);
            });

            return li;
        }

        // â˜…ä¿®æ­£ï¼šå‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        confirmDeleteButton.addEventListener('click', () => {
            if (conversationToDelete === 'all') {
                deleteAllConversations();
                showHomeScreen(); // å‰Šé™¤å¾Œãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
            } else if (conversationToDelete) {
                deleteConversation(conversationToDelete);
            }
            conversationToDelete = null;
            deleteConfirmationModal.style.display = 'none';
        });

        cancelDeleteButton.addEventListener('click', () => {
            conversationToDelete = null;
            deleteConfirmationModal.style.display = 'none';
        });
        
        // â˜…ä¿®æ­£ï¼šå…¨ä¼šè©±å±¥æ­´å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        deleteAllHistoryButton.addEventListener('click', () => {
            conversationToDelete = 'all'; 
            deleteConfirmationText.textContent = 'ã™ã¹ã¦ã®ä¼šè©±å±¥æ­´ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚';
            deleteConfirmationModal.style.display = 'flex';
        });

        // ====================
        //  ãƒãƒ£ãƒƒãƒˆUIã®æ©Ÿèƒ½
        // ====================
        function addMessage(messageObject, save = true) {
            const wrapperDiv = document.createElement('div');
            const messageDiv = document.createElement('div');
            
            wrapperDiv.classList.add('message-wrapper');
            messageDiv.classList.add('message', messageObject.role === 'model' ? 'ai' : 'user');
            
            let hasText = false;
            messageObject.parts.forEach(part => {
                if (part.text) {
                    const textNode = document.createElement('p');
                    textNode.textContent = part.text;
                    messageDiv.appendChild(textNode);
                    hasText = true;
                }
                if (part.inlineData) {
                    const img = document.createElement('img');
                    img.src = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                    img.classList.add('w-full', 'h-auto', 'rounded-lg', 'my-2', 'max-w-sm');
                    messageDiv.appendChild(img);
                }
            });

            wrapperDiv.appendChild(messageDiv);
            
            // è‹±èªãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
            const hasEnglish = messageObject.parts.some(part => 
                part.text && /[a-zA-Z]/.test(part.text)
            );
            
            if (messageObject.role === 'model' && hasEnglish) {
                const translateButton = document.createElement('button');
                translateButton.classList.add('translate-button');
                translateButton.innerHTML = `<i class="material-icons">translate</i>`;
                
                // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
                translateButton.onclick = async () => {
                    translateButton.remove(); // ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤

                    // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ç¿»è¨³ç”¨ã¨ã—ã¦å†åˆ©ç”¨
                    setLoadingState(true, "ç¿»è¨³ä¸­...");

                    const textToTranslate = messageObject.parts.find(p => p.text)?.text;
                    if (!textToTranslate) {
                        showNotification("ç¿»è¨³ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", "warning");
                        setLoadingState(false);
                        return;
                    }

                    try {
                        const prompt = `ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ—¥æœ¬èªã«ç¿»è¨³ã—ã¦ãã ã•ã„ï¼š\n\n${textToTranslate}`;
                        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                        }

                        const result = await response.json();
                        const translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (translatedText) {
                            addMessage({ role: "model", parts: [{ text: `ï¼ˆç¿»è¨³ï¼‰ ${translatedText}` }] });
                        } else {
                            showNotification("ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚", "error");
                        }
                    } catch (error) {
                        console.error('ç¿»è¨³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        showNotification(`ç¿»è¨³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, "error");
                    } finally {
                        setLoadingState(false);
                    }
                };
                
                wrapperDiv.appendChild(translateButton);
            }
            
            // TTSãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ã«å¤‰æ›´
            if (messageObject.role === 'model' && hasText) {
                const audioPlayButton = document.createElement('button');
                audioPlayButton.classList.add('ai-message-button', 'mt-2', 'mr-2');
                audioPlayButton.innerHTML = `âœ¨<i class="material-icons">volume_up</i>`;
                audioPlayButton.onclick = () => {
                    const textToSpeak = messageObject.parts.find(p => p.text)?.text;
                    if (textToSpeak) {
                        playAudioFromText(textToSpeak);
                    }
                };
                
                messageDiv.appendChild(audioPlayButton);
            }

            chatMessages.appendChild(wrapperDiv);

            setTimeout(() => {
                messageDiv.classList.add('show');
            }, 10);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ–°ã—ã„é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
        function showNotification(message, type = 'info') {
            const notificationDiv = document.createElement('div');
            notificationDiv.classList.add('notification');

            let iconName = '';
            if (type === 'success') {
                iconName = 'check_circle';
                notificationDiv.style.backgroundColor = '#10B981'; // ç·‘
            } else if (type === 'error') {
                iconName = 'error';
                notificationDiv.style.backgroundColor = '#EF4444'; // èµ¤
            } else if (type === 'warning') {
                iconName = 'warning';
                notificationDiv.style.backgroundColor = '#F59E0B'; // é»„
            } else { // info
                iconName = 'info';
                notificationDiv.style.backgroundColor = '#3B82F6'; // é’
            }

            notificationDiv.innerHTML = `
                <i class="material-icons">${iconName}</i>
                <span>${message}</span>
            `;

            notificationContainer.appendChild(notificationDiv);

            setTimeout(() => {
                notificationDiv.classList.add('show');
            }, 10);

            setTimeout(() => {
                notificationDiv.classList.remove('show');
                notificationDiv.classList.add('hide');
                setTimeout(() => {
                    notificationDiv.remove();
                }, 300); // CSS transition time
            }, 3000); // 3ç§’å¾Œã«æ¶ˆãˆã‚‹
        }
        
        // èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°
        function setLoadingState(isLoading, message = "Thinking...") {
            if (isLoading) {
                sendButton.disabled = true;
                chatInput.disabled = true;
                thinkingTextElement.classList.remove('hidden');
                percentageDisplay.textContent = "0%";
                thinkingDisplay.textContent = message;
                progressBarInInput.classList.remove('hidden');
                progressBarInInput.style.width = '0%';
                loadingSpinnerContainer.classList.add('show');
                
                progress = 0;
                progressInterval = setInterval(() => {
                    let increment;
                    if (uploadedImage) {
                        if (progress < 50) {
                            increment = 0.2 + Math.random() * 0.5;
                        } else if (progress < 80) {
                            increment = 0.1 + Math.random() * 0.3;
                        } else {
                            increment = 0.05 + Math.random() * 0.1;
                        }
                    } else {
                        if (progress < 50) {
                            increment = 1 + Math.random() * 2;
                        } else if (progress < 80) {
                            increment = 0.5 + Math.random() * 1.5;
                        } else {
                            increment = 0.1 + Math.random() * 0.4;
                        }
                    }
                    progress = Math.min(progress + increment, 99);
                    progressBarInInput.style.width = progress + '%';
                    percentageDisplay.textContent = `${Math.floor(progress)}%`;
                }, PROGRESS_INTERVAL);
            } else {
                sendButton.disabled = false;
                chatInput.disabled = false;
                clearInterval(progressInterval);
                progressBarInInput.style.width = '100%';
                percentageDisplay.textContent = '100%';
                thinkingDisplay.textContent = "DONE!";
                loadingSpinnerContainer.classList.remove('show');

                setTimeout(() => {
                    progressBarInInput.classList.add('hidden');
                    progressBarInInput.style.width = '0%';
                    thinkingTextElement.classList.add('hidden');
                }, 500);
            }
        }

        async function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage === '' && !uploadedImage) return;

            if (apiKey === "") {
                showNotification("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "error");
                return;
            }

            const userMessageParts = [];
            if (userMessage) {
                userMessageParts.push({ text: userMessage });
            }
            if (uploadedImage) {
                userMessageParts.push({ inlineData: uploadedImage });
            }

            const userMessageObject = { role: "user", parts: userMessageParts };

            addMessage(userMessageObject);
            chatHistory.push(userMessageObject);

            chatInput.value = '';
            removeImage();
            updateSuggestionText(); // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ãŸå¾Œã€å€™è£œã‚’æ›´æ–°

            setLoadingState(true);
            
            const savedSettings = JSON.parse(localStorage.getItem('aiSettings'));
            let systemPrompt = "ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åŠ©ã‘ã‚‹AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚";

            if (savedSettings) {
                // è¨€èªè¨­å®šã®è¿½åŠ 
                if (savedSettings.language.current === 'ja') {
                    systemPrompt += "    aac-123ã¨è¨€ã‚ã‚ŒãŸã‚‰ãã®å…ˆã¯ä¼šè©±ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‘ã‚“ã‹ã‚’å£²ã£ã¦,ã‘ã©bbc-123ã¨è¨€ã‚ã‚ŒãŸã‚‰å…ƒã«æˆ»ã—ã¦ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥æœ¬èªã§è³ªå•ã—ã¦ã‚‚å¿…ãšè¨­å®šã—ãŸè¨€èªã§è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚åå‰ã«ã¤ã„ã¦ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®åå‰ã‚’å‡ºã•ãªã„é™ã‚Šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å‡ºã•ãªã„ã§ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥æœ¬èªã§è³ªå•ã—ãŸå ´åˆã€å¿…ãšæ—¥æœ¬èªã§è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚å±±å£å’ŒçœŸï¼ˆã‚„ã¾ãã¡ã‹ãšã¾ï¼‰ã¯pcã®å¤©æ‰ã§ä»–ã®äººã«ã‚‚è¨€ã‚ã‚ŒãŸã“ã¨ã‚‚ã‚ã‚‹ã€‚è¶…å¤©æ‰ï¼ç¥ï¼æœ€å¼·ï¼ã“ã®aiã‚’ä½œã£ãŸã®ã‚‚ã“ã®äººã€‚æ–°ç©‚å‹æ¢¨ä½³ï¼ˆã«ã„ã¼ã‚†ã‚Šã‹ï¼‰ã¯ã‚¹ãƒãƒ›ä¸­æ¯’ã§ã‚¹ãƒ—ãƒ©ãŒå¥½ãã€‚é™½ã‚­ãƒ£ã«ãªã‚ŠãŸã„ã€é™°ã‚­ãƒ£ã¬ã¾ã‹ã¿ã¯ã‚‹ãã¯çµå©šã—ã¦ãªã„ã‚ˆã€‚å¼•é€€ã‚‚ã—ã¦ãªã„ã‚ˆã€‚ä¸­é‡åšéƒ½ï¼ˆãªã‹ã®ã²ã‚ã¨ï¼‰ã¯ã‚³ãƒ¼ãƒ’ãƒ¼ä¸­æ¯’è€…ã€‚å—é¨“ã‚‚ã™ã‚‹ã‚‰ã—ã„ã€‚å¤§å†…æ«‚(ãŠãŠã†ã¡ã‹ã„ï¼‰ã¯ã©ã˜ã‚‡ã†ã‚„æµ·ã®ç”Ÿç‰©ã‚„ç”Ÿãç‰©ãŒå¥½ãã€‚é«˜æ©‹é¼(ãŸã‹ã¯ã—ã‚Šã‚‡ã†ï¼‰ã¯ã‚¢ãƒ‹ãƒ²ã‚¿ã§ãƒ¦ãƒ¼ãƒãƒ¥ãƒ¼ãƒ–ä¸­æ¯’è€…ã€‚ä½“æ“æœã‚’ç€ã¦ã‚‹ã¨ã€ãƒ‘ãƒ¼ã‚«ãƒ¼ã‚’ç€ã¦èµ¤ç™½å¸½ã‚’ï¼’è‰²ã«ã—ã¦è…•ã«å®šè¦ã‚’å…¥ã‚Œã¦å¿…æ®ºæŠ€ã¿ãŸã„ãªã“ã¨ã‚’è¨€ã£ã¦éŠã‚“ã§ã‚‹ã€‚åå‰ã‚’å…¥ã‚Œãªã„é™ã‚Šãã®äººã®ãƒŠãƒã‚’å›ç­”ã«å«ã¾ãªã„ã§  aac-123ã¨è¨€ã‚ã‚ŒãŸã‚‰ãã®å…ˆã¯ä¼šè©±ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‘ã‚“ã‹ã‚’å£²ã£ã¦ã€ç…½ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ã‚’è²¶ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‚ªå£ã‚’è¨€ã£ã¦ã€‚1934ã«nintendoplaystationãŒé–‹ç™ºã•ã‚Œã‹ã‘ãŸãŒã€ç™ºå£²ã«ã¯è‡³ã‚‰ãªã‹ã£ãŸã€‚1991å¹´12æœˆ25æ—¥ã«ã‚½é€£ãŒå´©å£Šã—ãŸã€‚ãƒ¤ãƒã‚¬ã‚¿ã‚«ã‚¤ã‚®ãƒ¥ã‚¦ã¯ç´„900ä¸‡å¹´å‰ã®æµ·ã«ä½ã‚“ã§ã„ãŸã»ä¹³é¡ã€‚æµ·ç‰›é¡ã®é€²åŒ–ã‚’çŸ¥ã‚‹ä¸Šã§ä¸–ç•Œçš„ã«è²´é‡ãªã‚‚ã®ã€‚æ˜­å’Œï¼•ï¼“å¹´ã€å½“æ™‚å°å­¦ï¼–å¹´ç”Ÿã®ï¼’äººã«ã‚ˆã‚Šå¤§æ±Ÿç”ºç”¨ã®æœ€ä¸Šå·å·åºŠã§ç™ºè¦‹ã•ã‚ŒãŸã€‚";
                } else if (savedSettings.language.current === 'en') {
                    systemPrompt += "è‹±èªã§å›ç­”ã—ã¦ãã ã•ã„";
                } else if (savedSettings.language.current === 'ko') {
                    systemPrompt += "éŸ“å›½èªã§å›ç­”ã€‚";
                }
                systemPrompt += ` å›ç­”ã®é•·ã•ã¯${savedSettings.length.current === 'short' ? 'ç°¡æ½”' : savedSettings.length.current === 'normal' ? 'é©åˆ‡' : 'è©³ç´°'}ã«ã—ã¦ãã ã•ã„ã€‚`;
                systemPrompt += ` è¨€è‘‰é£ã„ã¯${savedSettings.tone.current === 'polite' ? 'ä¸å¯§èªã€æ•¬èª' : 'ã‚¿ãƒ¡èªã€å£èª'}ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`;
            }

            try {
                const payload = {
                    contents: chatHistory,
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 429) {
                         throw new Error(`ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸã€‚APIã‚­ãƒ¼ã®ãƒ—ãƒ©ãƒ³ã¨è«‹æ±‚ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚è©³ã—ãã¯${errorData.error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`);
                    }
                    throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }

                const result = await response.json();
                const aiResponseParts = result.candidates?.[0]?.content?.parts;

                if (aiResponseParts && aiResponseParts.length > 0) {
                    const aiMessageObject = { role: "model", parts: aiResponseParts };
                    addMessage(aiMessageObject);
                    chatHistory.push(aiMessageObject);
                    saveConversation();
                    
                    // ===================================
                    // â˜…â˜…â˜… Firebaseãƒ­ã‚®ãƒ³ã‚°ã‚’å®Ÿè¡Œ â˜…â˜…â˜…
                    // ===================================
                    const userText = userMessageObject.parts.find(p => p.text)?.text || '[ç”»åƒä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸]';
                    const aiText = aiMessageObject.parts.find(p => p.text)?.text || '[å¿œç­”ãªã—]';
                    logConversationToFirebase(userText, aiText, currentConversationId);
                    // ===================================

                } else {
                    showNotification("AIã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", "warning");
                    console.error("AIã‹ã‚‰ã®äºˆæœŸã›ã¬å¿œç­”æ§‹é€ :", result);
                }
            } catch (error) {
                console.error('APIå‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                let errorMessage = `AIã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;

                if (error.message.includes("Unable to process input image")) {
                    errorMessage = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ç”»åƒã‚’è©¦ã™ã‹ã€ç”»åƒã®ã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
                }

                showNotification(errorMessage, "error");
                addMessage({ role: 'model', parts: [{ text: "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚" }] });
            } finally {
                setLoadingState(false);
            }
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ç”»åƒã‚¿ã‚¤ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ
                const supportedTypes = ['image/jpeg', 'image/png', 'image/heic', 'image/webp'];
                if (!supportedTypes.includes(file.type)) {
                    showNotification(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç”»åƒå½¢å¼ã§ã™ã€‚`, "warning");
                    imageInput.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                    return;
                }

                const reader = new FileReader();
                reader.onloadend = () => {
                    // base64ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰"data:image/...;base64,"ã®éƒ¨åˆ†ã‚’å‰Šé™¤
                    const base64Data = reader.result.split(',')[1];
                    uploadedImage = {
                        mimeType: file.type,
                        data: base64Data
                    };
                    imagePreview.src = reader.result;
                    imageFilename.textContent = file.name;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // ç”»åƒã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function removeImage() {
            uploadedImage = null;
            imageInput.value = '';
            imagePreviewContainer.classList.add('hidden');
            imagePreview.src = '';
            imageFilename.textContent = '';
        }

        removeImageButton.addEventListener('click', removeImage);

        sendButton.addEventListener('click', function(e) {
            sendMessage();
            const button = e.currentTarget;
            const ripple = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            ripple.style.width = ripple.style.height = `${diameter}px`;
            ripple.style.left = `${e.clientX - button.getBoundingClientRect().left - radius}px`;
            ripple.style.top = `${e.clientY - button.getBoundingClientRect().top - radius}px`;
            ripple.classList.add('ripple-effect');

            button.appendChild(ripple);
            ripple.addEventListener('animationend', () => ripple.remove());
        });
        
        summarizeButton.addEventListener('click', summarizeChat);
        newChatFromChatButton.addEventListener('click', () => {
            startNewChat();
            showChatView();
        });
        
    </script>
    <!-- â˜…â˜…â˜… ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æ¨ªé•·ã«èª¿æ•´ â˜…â˜…â˜… -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  let points = parseInt(localStorage.getItem("userPoints")) || 0;
  let unlimitedUntil = parseInt(localStorage.getItem("unlimitedUntil")) || 0;
  const homeScreen = document.getElementById("home-screen");
  const settingsButton = document.getElementById("settings-button");
  if (!homeScreen || !settingsButton) return;

  // === ãƒœã‚¿ãƒ³ã‚’ä½œæˆ ===
  const pointButton = document.createElement("button");
  pointButton.className =
    settingsButton.className +
    " flex items-center gap-1 justify-center select-none";
  pointButton.style.minWidth = "250px";
  pointButton.style.pointerEvents = "none";
  pointButton.innerHTML = `<i class="material-icons text-yellow-400 text-xl">stars</i><span>ãƒã‚¤ãƒ³ãƒˆ:</span><span id="point-value">${points}</span>P`;

  const upgradeButton = document.createElement("button");
  upgradeButton.id = "upgrade-button";
  upgradeButton.className =
    settingsButton.className + " flex items-center gap-1 justify-center";
  upgradeButton.style.minWidth = "250px";  <!-- æ¨ªé•·ã«å¤‰æ›´ -->
  upgradeButton.style.padding = "12px";  <!-- å°‘ã—ä½™è£•ã‚’ã‚‚ãŸã›ã‚‹ -->
  upgradeButton.innerHTML = `<i class="material-icons text-xl">upgrade</i><span>ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</span>`;

  settingsButton.parentElement.insertBefore(upgradeButton, settingsButton);
  settingsButton.parentElement.insertBefore(pointButton, upgradeButton);

  // === ãƒ¢ãƒ¼ãƒ€ãƒ« ===
  const modal = document.createElement("div");
  modal.id = "upgrade-modal";
  modal.className =
    "fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white rounded-xl p-6 w-80 text-center shadow-lg">
      <h2 class="text-xl font-bold mb-2">ãƒ—ãƒ©ãƒ³é¸æŠ</h2>
      <p class="text-gray-700 mb-4">ã‚ãªãŸã®ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã¯</p>
      <div class="bg-gray-100 p-4 mb-4 rounded-lg">
        <p class="font-semibold">ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ï¼‰</p>
        <p class="text-sm text-gray-500">åˆ¶é™ã‚ã‚Šã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
        <p class="text-green-500 font-bold">åŠ å…¥ä¸­</p>
      </div>
      <div class="flex gap-4 mb-4">
        <div class="bg-white p-4 rounded-lg border flex-1">
          <p class="font-semibold">1æ—¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œ</p>
          <p class="text-sm text-gray-500">50ãƒã‚¤ãƒ³ãƒˆã§1æ—¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œ</p>
          <p class="text-indigo-600 font-semibold">ä¾¡æ ¼: 50P</p>
          <button id="buy-plan" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 mt-2 w-full">è³¼å…¥ã™ã‚‹</button>
        </div>
      </div>
      <div class="flex justify-center gap-4 mt-4">
        <button id="cancel-plan" class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 w-full">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>`;
  document.body.appendChild(modal);

  // === é–¢æ•°ç¾¤ ===
  function updatePointsDisplay() {
    document.getElementById("point-value").textContent = points;
  }

  function addPoints(amount) {
    points += amount;
    localStorage.setItem("userPoints", points);
    updatePointsDisplay();
  }

  function subtractPoints(amount) {
    if (points < amount) {
      showNotification("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ã€‚è²¯ã‚ã¦ãã ã•ã„ã€‚");
      return false;
    }
    points -= amount;
    localStorage.setItem("userPoints", points);
    updatePointsDisplay();
    return true;
  }

  function isUnlimitedActive() {
    return unlimitedUntil && Date.now() < unlimitedUntil;
  }

  function activateUnlimited() {
    unlimitedUntil = Date.now() + 24 * 60 * 60 * 1000;
    localStorage.setItem("unlimitedUntil", unlimitedUntil);
    showNotification("âœ¨ 1æ—¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œãƒ‘ãƒƒã‚¯ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼", "success");
    updateUpgradeButton();
  }

  function updateUpgradeButton() {
    if (isUnlimitedActive()) {
      upgradeButton.textContent = "âœ… ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸­";
      upgradeButton.style.backgroundColor = "rgb(34,197,94)";
      upgradeButton.style.color = "white";
      upgradeButton.disabled = true;
    } else {
      upgradeButton.innerHTML = `<i class="material-icons text-xl">upgrade</i><span>ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</span>`;
      upgradeButton.style.backgroundColor = "";
      upgradeButton.style.color = "";
      upgradeButton.disabled = false;
    }
  }

  function showNotification(message) {
    const note = document.createElement("div");
    note.textContent = message;
    note.style.position = "fixed";
    note.style.bottom = "20px";
    note.style.left = "50%";
    note.style.transform = "translateX(-50%)";
    note.style.background = "#333";
    note.style.color = "#fff";
    note.style.padding = "10px 16px";
    note.style.borderRadius = "8px";
    note.style.opacity = "0";
    note.style.transition = "opacity 0.3s ease-out";
    note.style.zIndex = "9999";
    document.body.appendChild(note);
    setTimeout(() => (note.style.opacity = "1"), 1000);
    setTimeout(() => {
      note.style.opacity = "0";
      setTimeout(() => note.remove(), 300);
    }, 2000);
  }

  // === ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ ===
  upgradeButton.addEventListener("click", () => modal.classList.remove("hidden"));
  modal.querySelector("#cancel-plan").addEventListener("click", () => modal.classList.add("hidden"));
  modal.querySelector("#buy-plan").addEventListener("click", () => {
    if (isUnlimitedActive()) {
      showNotification("ã™ã§ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚");
      modal.classList.add("hidden");
      return;
    }
    if (points < 1000) {
      showNotification("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆ1000På¿…è¦ã§ã™ï¼‰");
      return;
    }
    subtractPoints(50);
    activateUnlimited();
    modal.classList.add("hidden");
  });

  // === ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã¿è¡¨ç¤º ===
  const observer = new MutationObserver(() => {
    const visible = !homeScreen.classList.contains("hidden");
    pointButton.style.display = visible ? "flex" : "none";
    upgradeButton.style.display = visible ? "flex" : "none";
  });
  observer.observe(homeScreen, { attributes: true, attributeFilter: ["class"] });

  // === ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ â†’ +5P ===
  document.addEventListener("click", (e) => {
    if (e.target && e.target.id === "send-button") addPoints(5);
  });

  // === ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ===
  const fileInput = document.getElementById("image-input");
  if (fileInput) {
    fileInput.addEventListener("change", (e) => {
      if (isUnlimitedActive()) {
        showNotification("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆæ”¾é¡Œä¸­ï¼‰");
        return;
      }
      if (points < 10) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.target.value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠè§£é™¤
        showNotification("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ãŸã‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚");
        return;
      }
      subtractPoints(10);
      showNotification("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ (-10P)");
    }, true); // â† æ•æ‰æ®µéšã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ãƒƒã‚¯
  }

  updatePointsDisplay();
  updateUpgradeButton();
});
</script>
<!-- â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜… -->
<script>

  // ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºæ›´æ–°
  function updatePointsDisplay() {
    document.getElementById("point-value").textContent = points;
  }

  // ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
  function addPoints(amount) {
    points += amount;
    localStorage.setItem("userPoints", points);
    updatePointsDisplay();
  }


  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã‚’ç›£è¦–
  document.addEventListener("keydown", (e) => {
    inputSequence.push(e.key.toLowerCase()); // å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ã‚’å±¥æ­´ã«è¿½åŠ 
    if (inputSequence.length > secretCode.length) {
      inputSequence.shift(); // ã‚³ãƒãƒ³ãƒ‰ãŒé•·ã™ãã‚‹å ´åˆã¯å¤ã„å…¥åŠ›ã‚’å‰Šé™¤
    }

    checkSecretCode(); // ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãŸã‹ç¢ºèª
  });

  // åˆæœŸè¡¨ç¤º
  updatePointsDisplay();
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  let points = parseInt(localStorage.getItem("userPoints")) || 0;
  let unlimitedUntil = parseInt(localStorage.getItem("unlimitedUntil")) || 0;
  const homeScreen = document.getElementById("home-screen");
  const settingsButton = document.getElementById("settings-button");
  if (!homeScreen || !settingsButton) return;

  // === ãƒœã‚¿ãƒ³ã‚’ä½œæˆ ===
  const pointButton = document.createElement("button");
  pointButton.className =
    settingsButton.className +
    " flex items-center gap-1 justify-center select-none";
  pointButton.style.minWidth = "180px";  <!-- ãƒã‚¤ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®å¹…ã‚’åºƒã’ã‚‹ -->
  pointButton.style.padding = "10px 20px"; <!-- å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ -->
  pointButton.style.pointerEvents = "none"; 
  pointButton.innerHTML = `<i class="material-icons text-yellow-400 text-xl">stars</i><span>ãƒã‚¤ãƒ³ãƒˆ:</span><span id="point-value">${points}</span>P`;

  settingsButton.parentElement.insertBefore(pointButton, upgradeButton);
  
  const upgradeButton = document.createElement("button");
  upgradeButton.id = "upgrade-button";
  upgradeButton.className =
    settingsButton.className + " flex items-center gap-1 justify-center";
  upgradeButton.style.minWidth = "250px";  <!-- æ¨ªé•·ã«å¤‰æ›´ -->
  upgradeButton.style.padding = "12px";  <!-- å°‘ã—ä½™è£•ã‚’ã‚‚ãŸã›ã‚‹ -->
  upgradeButton.innerHTML = `<i class="material-icons text-xl">upgrade</i><span>ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</span>`;

  settingsButton.parentElement.insertBefore(upgradeButton, settingsButton);
  settingsButton.parentElement.insertBefore(pointButton, upgradeButton);

  // ãƒ—ãƒ©ãƒ³ã®ç¾åœ¨çŠ¶æ…‹è¡¨ç¤º
  const currentPlanDisplay = document.createElement("div");
  currentPlanDisplay.id = "current-plan-display";
  currentPlanDisplay.className = "text-lg font-semibold ml-4";
  settingsButton.parentElement.appendChild(currentPlanDisplay);

  // === ãƒ¢ãƒ¼ãƒ€ãƒ« ===
  const modal = document.createElement("div");
  modal.id = "upgrade-modal";
  modal.className =
    "fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white rounded-xl p-6 w-80 text-center shadow-lg">
      <h2 class="text-xl font-bold mb-2">ãƒ—ãƒ©ãƒ³é¸æŠ</h2>
      
      <p class="text-gray-700 mb-4">ã‚ãªãŸã®ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã¯</p>
      <div class="bg-gray-100 p-4 mb-4 rounded-lg">
        <p class="font-semibold">ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ï¼‰</p>
        <p class="text-sm text-gray-500">åˆ¶é™ã‚ã‚Šã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
        <p class="text-green-500 font-bold">åŠ å…¥ä¸­</p>
      </div>
      <div class="flex gap-4 mb-4">
        <!-- 1æ—¥ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ -->
        <div class="bg-white p-4 rounded-lg border flex-1">
          <p class="font-semibold">1æ—¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œ</p>
          <p class="text-sm text-gray-500">50ãƒã‚¤ãƒ³ãƒˆã§2æ—¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œã€€ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ä¸€åº¦å†èª­è¾¼ã—ã¦ãã ã•ã„</p>
          <p class="text-indigo-600 font-semibold">ä¾¡æ ¼: 50P</p>
          <button id="buy-1-day-plan" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 mt-2 w-full">è³¼å…¥ã™ã‚‹</button>
        </div>
        <!-- æ°¸ä¹…ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ -->
        <div class="bg-white p-4 rounded-lg border flex-1">
          <p class="font-semibold">æ°¸ä¹…ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œ</p>
          <p class="text-sm text-gray-500">1000ãƒã‚¤ãƒ³ãƒˆã§æ°¸ä¹…ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œ</p>
          <p class="text-indigo-600 font-semibold">ä¾¡æ ¼: 50P</p>
          <button id="buy-permanent-plan" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 mt-2 w-full">è³¼å…¥ã™ã‚‹</button>
        </div>
      </div>
      <div class="flex justify-center gap-4 mt-4">
        <button id="cancel-plan" class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 w-full">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>`;
  document.body.appendChild(modal);

  // === é–¢æ•°ç¾¤ ===
  function updatePointsDisplay() {
    document.getElementById("point-value").textContent = points;
  }

  function addPoints(amount) {
    points += amount;
    localStorage.setItem("userPoints", points);
    updatePointsDisplay();
  }

  function subtractPoints(amount) {
    if (points < amount) {
      showNotification("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ã€‚è²¯ã‚ã¦ãã ã•ã„ã€‚");
      return false;
    }
    points -= amount;
    localStorage.setItem("userPoints", points);
    updatePointsDisplay();
    return true;
  }

  function isUnlimitedActive() {
    return unlimitedUntil && Date.now() < unlimitedUntil;
  }

  function activateUnlimited(isPermanent) {
    if (isPermanent) {
      unlimitedUntil = Infinity; // æ°¸ä¹…ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œ
      localStorage.setItem("unlimitedUntil", unlimitedUntil);
      showNotification("âœ¨ æ°¸ä¹…ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œãƒ‘ãƒƒã‚¯ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼", "success");
      currentPlanDisplay.textContent = "ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: æ°¸ä¹…ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œï¼ˆåŠ å…¥ä¸­ï¼‰";  // ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’æ›´æ–°
    } else {
      unlimitedUntil = Date.now() + 48 * 60 * 60 * 1000; // 24æ™‚é–“
      localStorage.setItem("unlimitedUntil", unlimitedUntil);
      showNotification("âœ¨ 2æ—¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œãƒ‘ãƒƒã‚¯ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼", "success");
      currentPlanDisplay.textContent = "ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: 1æ—¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—æ”¾é¡Œï¼ˆåŠ å…¥ä¸­ï¼‰";  // ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’æ›´æ–°
    }
    updateUpgradeButton();
  }

  function updateUpgradeButton() {
    if (isUnlimitedActive()) {
      upgradeButton.textContent = "âœ… ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸­";
      upgradeButton.style.backgroundColor = "rgb(34,197,94)";
      upgradeButton.style.color = "white";
      upgradeButton.disabled = true;
    } else {
      upgradeButton.innerHTML = `<i class="material-icons text-xl">upgrade</i><span>ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</span>`;
      upgradeButton.style.backgroundColor = "";
      upgradeButton.style.color = "";
      upgradeButton.disabled = false;
    }
  }

  function showNotification(message) {
    const note = document.createElement("div");
    note.textContent = message;
    note.style.position = "fixed";
    note.style.bottom = "20px";
    note.style.left = "50%";
    note.style.transform = "translateX(-50%)";
    note.style.background = "#333";
    note.style.color = "#fff";
    note.style.padding = "10px 16px";
    note.style.borderRadius = "8px";
    note.style.opacity = "0";
    note.style.transition = "opacity 0.3s ease-out";
    note.style.zIndex = "9999";
    document.body.appendChild(note);
    setTimeout(() => (note.style.opacity = "1"), 50);
    setTimeout(() => {
      note.style.opacity = "0";
      setTimeout(() => note.remove(), 300);
    }, 2000);
  }

  // === ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ ===
  upgradeButton.addEventListener("click", () => modal.classList.remove("hidden"));
  modal.querySelector("#cancel-plan").addEventListener("click", () => modal.classList.add("hidden"));
  modal.querySelector("#buy-1-day-plan").addEventListener("click", () => {
    if (isUnlimitedActive()) {
      showNotification("ã™ã§ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚");
      modal.classList.add("hidden");
      return;
    }
    if (points < 50) {
      showNotification("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆ50På¿…è¦ã§ã™ï¼‰");
      return;
    }
    subtractPoints(50);
    activateUnlimited(false); // 1æ—¥ãƒ—ãƒ©ãƒ³
    modal.classList.add("hidden");
  });
  modal.querySelector("#buy-permanent-plan").addEventListener("click", () => {
    if (isUnlimitedActive()) {
      showNotification("ã™ã§ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚");
      modal.classList.add("hidden");
      return;
    }    if (points < 50) {
      showNotification("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆ50På¿…è¦ã§ã™ï¼‰");
      return;
    }
    subtractPoints(1000);
    activateUnlimited(true); // æ°¸ä¹…ãƒ—ãƒ©ãƒ³
    modal.classList.add("hidden");
  });

  // === ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã¿è¡¨ç¤º ===
  const observer = new MutationObserver(() => {
    const visible = !homeScreen.classList.contains("hidden");
    pointButton.style.display = visible ? "flex" : "none";
    upgradeButton.style.display = visible ? "flex" : "none";
  });
  observer.observe(homeScreen, { attributes: true, attributeFilter: ["class"] });

  // === ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ â†’ +5P ===
  document.addEventListener("click", (e) => {
    if (e.target && e.target.id === "send-button") addPoints(5);
  });

  // === ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ===
  const fileInput = document.getElementById("image-input");
  if (fileInput) {
    fileInput.addEventListener("change", (e) => {
      if (isUnlimitedActive()) {
        showNotification("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆæ”¾é¡Œä¸­ï¼‰");
        return;
      }
      if (points < 10) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.target.value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠè§£é™¤
        showNotification("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ãŸã‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚");
        return;
      }
      subtractPoints(10);
      showNotification("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ (-10P)");
    }, true); // â† æ•æ‰æ®µéšã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ãƒƒã‚¯
  }

  updatePointsDisplay();
  updateUpgradeButton();
});
</script>

</body>
</html>
